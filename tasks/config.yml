---
# Настройка конфигурации zsh

- name: Проверка существования .zshrc
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.zshrc"
  register: zshrc_stat
  tags:
    - zsh
    - config
    - zsh:config

- name: Резервное копирование существующего .zshrc
  ansible.builtin.copy:
    src: "{{ zsh_user_home }}/.zshrc"
    dest: "{{ zsh_user_home }}/.zshrc.backup.{{ ansible_date_time.epoch }}"
    remote_src: true
  when:
    - zsh_backup_existing_configs | bool
    - zshrc_stat.stat.exists
  tags:
    - zsh
    - config
    - zsh:config

- name: Создание .zshrc с настройками
  ansible.builtin.template:
    src: zshrc.j2
    dest: "{{ zsh_user_home }}/.zshrc"
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0644'
  tags:
    - zsh
    - config
    - zsh:config

- name: Проверка существования .p10k.zsh
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.p10k.zsh"
  register: p10k_config_stat
  when: zsh_create_p10k_config | bool
  tags:
    - zsh
    - config
    - zsh:config

- name: Резервное копирование существующего .p10k.zsh
  ansible.builtin.copy:
    src: "{{ zsh_user_home }}/.p10k.zsh"
    dest: "{{ zsh_user_home }}/.p10k.zsh.backup.{{ ansible_date_time.epoch }}"
    remote_src: true
  when:
    - zsh_backup_existing_configs | bool
    - zsh_create_p10k_config | bool
    - p10k_config_stat.stat.exists
  tags:
    - zsh
    - config
    - zsh:config

- name: Создание базового .p10k.zsh конфига
  ansible.builtin.template:
    src: p10k.zsh.j2
    dest: "{{ zsh_user_home }}/.p10k.zsh"
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0644'
  when:
    - zsh_create_p10k_config | bool
    - zsh_theme == "powerlevel10k/powerlevel10k"
    - zsh_install_powerlevel10k | bool
  tags:
    - zsh
    - config
    - zsh:config

- name: Проверка создания конфигурационных файлов
  ansible.builtin.stat:
    path: "{{ item }}"
  register: config_files_check
  loop:
    - "{{ zsh_user_home }}/.zshrc"
  tags:
    - zsh
    - config
    - zsh:config

- name: Проверка наличия .zshrc после установки
  ansible.builtin.assert:
    that:
      - config_files_check.results[0].stat.exists
    fail_msg: ".zshrc не создан"
    success_msg: ".zshrc успешно создан"
  tags:
    - zsh
    - config
    - zsh:config
