---
# Установка oh-my-zsh

- name: Создание директории .oh-my-zsh если не существует
  ansible.builtin.file:
    path: "{{ zsh_user_home }}/.oh-my-zsh"
    state: directory
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0755'
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Проверка существования oh-my-zsh
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.oh-my-zsh"
  register: ohmyzsh_stat
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Проверка наличия git перед установкой oh-my-zsh
  ansible.builtin.assert:
    that:
      - git_check is defined
      - git_check.rc == 0
    fail_msg: "Git не установлен. Установка oh-my-zsh невозможна."
    success_msg: "Git найден, можно устанавливать oh-my-zsh"
  when: zsh_check_git | bool
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Проверка наличия oh-my-zsh.sh
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.oh-my-zsh/oh-my-zsh.sh"
  register: ohmyzsh_sh_stat
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Удаление неполной установки oh-my-zsh
  ansible.builtin.file:
    path: "{{ zsh_user_home }}/.oh-my-zsh"
    state: absent
  when:
    - ohmyzsh_stat.stat.exists
    - not ohmyzsh_sh_stat.stat.exists
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Клонирование oh-my-zsh
  ansible.builtin.git:
    repo: "{{ zsh_ohmyzsh_repo }}"
    dest: "{{ zsh_user_home }}/.oh-my-zsh"
    version: "{{ zsh_ohmyzsh_version }}"
    update: true
    force: true
    depth: 1
  become_user: "{{ zsh_user }}"
  when:
    - zsh_check_git | bool
    - git_check is defined
    - git_check.rc == 0
    - not (ohmyzsh_sh_stat.stat.exists | default(false))
  register: ohmyzsh_clone
  async: 300
  poll: 10
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Обновление oh-my-zsh (если уже установлен)
  ansible.builtin.git:
    repo: "{{ zsh_ohmyzsh_repo }}"
    dest: "{{ zsh_user_home }}/.oh-my-zsh"
    version: "{{ zsh_ohmyzsh_version }}"
    update: true
    depth: 1
  become_user: "{{ zsh_user }}"
  when:
    - zsh_check_git | bool
    - git_check is defined
    - git_check.rc == 0
    - ohmyzsh_sh_stat.stat.exists | default(false)
  async: 300
  poll: 10
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Проверка успешной установки oh-my-zsh
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.oh-my-zsh/oh-my-zsh.sh"
  register: ohmyzsh_final_check
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh- name: Проверка наличия oh-my-zsh.sh после установки
  ansible.builtin.assert:
    that:
      - ohmyzsh_final_check.stat.exists
    fail_msg: "Oh-my-zsh не установлен корректно. Файл oh-my-zsh.sh не найден."
    success_msg: "Oh-my-zsh успешно установлен"
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh- name: Создание директории для кастомных плагинов
  ansible.builtin.file:
    path: "{{ zsh_user_home }}/.oh-my-zsh/custom/plugins"
    state: directory
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0755'
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh

- name: Создание директории для кастомных тем
  ansible.builtin.file:
    path: "{{ zsh_user_home }}/.oh-my-zsh/custom/themes"
    state: directory
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0755'
  tags:
    - zsh
    - ohmyzsh
    - zsh:ohmyzsh